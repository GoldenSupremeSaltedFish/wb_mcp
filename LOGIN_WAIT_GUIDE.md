# 🔐 登录等待和自动恢复流程指南

## ✅ 已实现的功能

### 1. **自动等待用户登录**
- 检测到登录页面时，自动显示浏览器窗口
- 开始轮询检查登录状态（每2秒）
- 等待用户手动登录（扫码/密码）

### 2. **登录状态检测**
- 多种方式检测登录状态：
  - DOM元素检测（用户信息元素）
  - Cookie检测（SUB、SUBP、WBPSESS）
  - URL检测（是否在登录页）

### 3. **自动导航到首页**
- 登录成功后自动检测
- 如果还在登录页，自动导航到 `https://weibo.com`
- 等待页面加载完成
- 验证首页元素存在

### 4. **页面状态检查**
- 执行脚本前检查是否在首页
- 检查首页DOM元素是否存在
- 如果不在首页，自动导航到首页

### 5. **完整的恢复流程**
```
工具调用
  ↓
检查Electron环境
  ↓
检查登录状态
  ↓ (如果未登录)
等待用户登录 (显示窗口，轮询检查)
  ↓ (登录成功)
导航到首页
  ↓
验证首页元素
  ↓
执行脚本
```

## 🔧 关键方法

### `browserManager.waitForLogin(timeout)`
等待用户登录完成，最多等待5分钟（默认）

```typescript
const loggedIn = await browserManager.waitForLogin();
if (!loggedIn) {
  throw new Error('登录超时');
}
```

### `browserManager.ensureOnHomePage()`
确保在首页，如果不在则自动导航

```typescript
await browserManager.ensureOnHomePage();
// 现在保证在首页
```

### `browserManager.isOnHomePage()`
检查当前是否在首页

```typescript
const isHome = await browserManager.isOnHomePage();
```

## 📋 使用流程

### 场景1：首次使用（需要登录）

1. **调用工具**（如 `post_weibo`）
2. **系统检测**到未登录
3. **自动显示**浏览器窗口
4. **用户手动登录**（扫码或密码）
5. **系统检测**到登录成功
6. **自动导航**到首页
7. **执行操作**（发布微博等）

### 场景2：已登录但不在首页

1. **调用工具**
2. **系统检测**到已登录但不在首页
3. **自动导航**到首页
4. **验证首页元素**
5. **执行操作**

### 场景3：已登录且在首页

1. **调用工具**
2. **系统检测**到已在首页
3. **直接执行操作**

## 🔍 日志追踪

所有关键步骤都有详细的日志：

```
🔐 开始等待用户登录...
✅ 登录成功！准备导航到首页...
🔄 从登录页导航到首页...
✅ 已成功导航到首页
✅ 当前已在首页
⚠️ 当前不在首页: https://weibo.com/newlogin...
```

## ⚠️ 注意事项

1. **登录超时**：默认等待5分钟，如果超时会抛出错误
2. **页面加载**：导航到首页后会等待2秒确保元素加载完成
3. **元素检查**：会检查多种首页元素，确保是真正的首页
4. **错误处理**：如果无法导航到首页，会返回明确的错误信息

## 🧪 测试方法

### 测试登录等待

```bash
# 1. 启动Electron应用
pnpm start:electron

# 2. 调用post_weibo工具（此时应该未登录）
# 系统会自动显示窗口等待登录

# 3. 在浏览器窗口中手动登录

# 4. 观察日志，应该看到：
# - "开始等待用户登录"
# - "登录成功！准备导航到首页"
# - "已成功导航到首页"
# - 然后执行发布操作
```

### 测试自动恢复

```bash
# 1. 确保已登录
# 2. 手动导航到其他页面（如个人主页）
# 3. 调用post_weibo工具
# 4. 系统应该自动导航回首页并执行操作
```

## 📝 代码示例

### 在API中使用

```typescript
// 在postWeibo中
await browserManager.ensureOnHomePage(); // 自动处理登录和导航

// 然后执行脚本
const result = await injectionTools.executeInPageContext(script);
```

### 手动等待登录

```typescript
// 如果需要手动控制
const loggedIn = await browserManager.waitForLogin(60000); // 等待60秒
if (loggedIn) {
  // 继续操作
}
```

## 🎯 解决的问题

✅ **问题1**：在登录页执行脚本导致"未找到发布方法"
- **解决**：执行前检查页面状态，确保在首页

✅ **问题2**：用户未登录时无法操作
- **解决**：自动等待用户登录

✅ **问题3**：登录后还在登录页
- **解决**：登录成功后自动导航到首页

✅ **问题4**：页面状态不确定
- **解决**：多重检查（URL + DOM元素）

